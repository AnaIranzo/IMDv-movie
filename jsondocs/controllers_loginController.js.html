<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/loginController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/loginController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @author AnaIranzo &lt;aeiranzom@gmail.com>
 * @author ManuelMurillo &lt;mmpeira@gmail.com>
 * @author JorgeMartin &lt;jorge.martin.carrion@gmail.com>
 * @exports  movies
 * @namespace LoginControllers
 */

const pool = require('../utils/db');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');
const cookieParser = require('cookie-parser')


const getLogin = (req,res)=> {
    res.render("login")
  }

    /**
  * Descripción de la función: Checkea si el usuario,email y contraseña,  coinciden con la BBDD.
  * @memberof LoginControllers
  * @method postLogin
  * @async
  * @param {User} Usuario - Nombre del usuario en la BBDD.
  * @param {Email} Email - Email de usuario.
  * @param {password} Contraseña - Contraseña del usuario.
  * @throws {error} Usuario incorrecto.
  * @throws {error} El email introducido no es correcto.
  * @throws {error} La contraseña es incorrecta.
  */

const postLogin = async (req, res) => {
    const { email, password } = req.body;
    // Buscar al usuario en la base de datos
    const user = await pool.query('SELECT * FROM usuarios WHERE email = $1', [email]);
    if (user.rows.length === 0) {
      return res.render("login" , {msj: "El email introducido no es correcto"})
    }
    // Verificar la contraseña
    const isPasswordCorrect = await bcrypt.compare(password, user.rows[0].password);
    if (!isPasswordCorrect) {
      return res.render("login" , {msj: "La contraseña es incorrecta"}) 
    }
  
    const userForToken = {
      userLog : user,
    
  }

  const token = jwt.sign(userForToken, process.env.CLAVE);

  if (userForToken.userLog.rows[0].role === 'user') {
    res.cookie("access_token", token, {
      httpOnly: true,
      secure: "production",
    })
    .status(200)
    .redirect('index');
  }else if (userForToken.userLog.rows[0].role === 'admin') {
    res.cookie("access_token", token, {
      httpOnly: true,
      secure: "production",
    })
    .status(200)
    .redirect('admin');
  }
};



module.exports = {
    getLogin,
    postLogin
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="LoginControllers.html">LoginControllers</a></li><li><a href="SQL.html">SQL</a></li><li><a href="SQLSchema.html">SQLSchema</a></li><li><a href="moviesAdminController.html">moviesAdminController</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Tue Feb 07 2023 17:47:30 GMT+0100 (hora estándar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
